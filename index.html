<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовые данные по акциям</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .lang-switcher { text-align: center; margin-bottom: 20px; }
        .lang-switcher button { padding: 8px 15px; margin: 0 5px; border: 1px solid #3498db; background-color: #fff; color: #3498db; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .lang-switcher button.active { background-color: #3498db; color: white; }
        h1 { color: #2c3e50; text-align: center; font-size: 1.8em; }
        .input-group { display: flex; margin-bottom: 20px; }
        #tickers-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px 0 0 4px; font-size: 16px; }
        #fetch-btn { padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #ecf0f1; color: #2c3e50; position: relative; }
        .price-plus { color: #27ae60; font-weight: bold; }
        .price-minus { color: #c0392b; font-weight: bold; }
        #period-select { font-size: 12px; padding: 2px; border-radius: 4px; border: 1px solid #ccc; }
        .tooltip-text { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #34495e; color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: normal; width: 250px; text-align: center; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; z-index: 10; }
        th:hover .tooltip-text { opacity: 1; visibility: visible; }
        body.rtl { direction: rtl; } body.rtl th, body.rtl td { text-align: right; }
        @media screen and (max-width: 768px) {
            thead { display: none; }
            tr { margin-bottom: 15px; border: 1px solid #ddd; }
            table, tbody, th, td, tr { display: block; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; }
            td:before { position: absolute; top: 12px; left: 12px; width: 45%; content: attr(data-label); font-weight: bold; text-align: left;}
            td:first-of-type { background-color: #ecf0f1; font-weight: bold; font-size: 1.2em; padding-left: 12px; }
            td:first-of-type:before { display: none; }
            body.rtl td { text-align: left; padding-left: 0; padding-right: 50%;}
            body.rtl td:before { right: 12px; left: auto; text-align: right;}
            body.rtl td:first-of-type { padding-right: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switcher">
            <button id="lang-en">English</button>
            <button id="lang-ru" class="active">Русский</button>
            <button id="lang-he">עברית</button>
        </div>
        <h1 data-lang-key="title"></h1>
        <p data-lang-key="subtitle"></p>
        <div class="input-group">
            <input type="text" id="tickers-input" data-lang-key-placeholder="placeholder">
            <button id="fetch-btn" data-lang-key="fetch_btn"></button>
        </div>
        <div id="loader" class="loader" data-lang-key="loader"></div>
        <table id="stock-table">
            <thead>
                <tr>
                    <th data-lang-key="h_ticker" data-tooltip-key="e_ticker"></th>
                    <th data-lang-key="h_price" data-tooltip-key="e_price"></th>
                    <th>
                        <span data-lang-key="h_change"></span>
                        <select id="period-select">
                            <option value="today" data-lang-key="p_today"></option>
                            <option value="week" data-lang-key="p_week"></option>
                            <option value="month" data-lang-key="p_month"></option>
                            <option value="1Y" data-lang-key="p_1y"></option>
                            <option value="5Y" data-lang-key="p_5y"></option>
                        </select>
                    </th>
                    <th data-lang-key="h_market_cap" data-tooltip-key="e_market_cap"></th>
                    <th data-lang-key="h_pe" data-tooltip-key="e_pe"></th>
                    <th data-lang-key="h_pb" data-tooltip-key="e_pb"></th>
                    <th data-lang-key="h_ps" data-tooltip-key="e_ps"></th>
                    <th data-lang-key="h_eps" data-tooltip-key="e_eps"></th>
                    <th data-lang-key="h_roe" data-tooltip-key="e_roe"></th>
                    <th data-lang-key="h_roa" data-tooltip-key="e_roa"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        let tickersOnScreen = [];
        const translations = {
            en: { title: 'Stock Analysis 📈', subtitle: 'Enter tickers separated by commas (e.g., AAPL, MSFT, LUMI.TA).', placeholder: 'AAPL,MSFT,LUMI.TA', fetch_btn: 'Get Data', loader: 'Loading...', h_ticker: 'Ticker', h_price: 'Price', h_change: 'Change', h_market_cap: 'Market Cap', h_pe: 'P/E', h_pb: 'P/B', h_ps: 'P/S', h_eps: 'EPS', h_roe: 'ROE %', h_roa: 'ROA %', e_ticker: 'Stock symbol.', e_price: 'Price from the last trading day.', e_market_cap: 'Market Capitalization. <b>Bigger = Larger company.</b>', e_pe: 'Price / Earnings. <b>Lower is better.</b>', e_pb: 'Price / Book Value. <b>Lower (esp. <1) is better.</b>', e_ps: 'Price / Sales. <b>Lower is better.</b>', e_eps: 'Earnings Per Share. <b>Higher is better.</b>', e_roe: 'Return On Equity. <b>Higher is better.</b>', e_roa: 'Return On Assets. <b>Higher is better.</b>', p_today: 'Today', p_week: 'Week', p_month: 'Month', p_1y: 'Year', p_5y: '5 years', alert_no_ticker: 'Please enter at least one ticker.', error_fetch: 'Failed to load data.' },
            ru: { title: 'Анализ акций 📈', subtitle: 'Введите тикеры через запятую (например: AAPL, MSFT, LUMI.TA).', placeholder: 'AAPL,MSFT,LUMI.TA', fetch_btn: 'Получить данные', loader: 'Загрузка...', h_ticker: 'Тикер', h_price: 'Цена', h_change: 'Изменение', h_market_cap: 'Market Cap', h_pe: 'P/E', h_pb: 'P/B', h_ps: 'P/S', h_eps: 'EPS', h_roe: 'ROE %', h_roa: 'ROA %', e_ticker: 'Символ акции.', e_price: 'Цена по итогам последнего торг. дня.', e_market_cap: 'Рыночная капитализация. <b>Больше = крупнее.</b>', e_pe: 'Цена / Прибыль. <b>Чем ниже, тем лучше.</b>', e_pb: 'Цена / Баланс. стоимость. <b>Чем ниже (особенно <1), тем лучше.</b>', e_ps: 'Цена / Выручка. <b>Чем ниже, тем лучше.</b>', e_eps: 'Прибыль на акцию. <b>Чем больше, тем лучше.</b>', e_roe: 'Рентабельность капитала. <b>Чем больше, тем лучше.</b>', e_roa: 'Рентабельность активов. <b>Чем больше, тем лучше.</b>', p_today: 'Сегодня', p_week: 'Неделя', p_month: 'Месяц', p_1y: 'Год', p_5y: '5 лет', alert_no_ticker: 'Введите хотя бы один тикер.', error_fetch: 'Не удалось загрузить данные.' },
            he: { title: 'ניתוח מניות 📈', subtitle: 'הזן סימבולים בנפרד פסיק (לדוגמה: AAPL, MSFT, LUMI.TA).', placeholder: 'AAPL,MSFT,LUMI.TA', fetch_btn: 'קבל נתונים', loader: 'טוען...', h_ticker: 'סימבול', h_price: 'מחיר', h_change: 'שינוי', h_market_cap: 'שווי שוק', h_pe: 'מכפיל רווח', h_pb: 'מכפיל הון', h_ps: 'מכפיל מכירות', h_eps: 'רווח למניה', h_roe: 'תשואה להון', h_roa: 'תשואה לנכסים', e_ticker: 'סימול המניה.', e_price: 'מחיר מיום המסחר האחרון.', e_market_cap: 'שווי שוק. <b>גדול יותר = חברה גדולה יותר.</b>', e_pe: 'מחיר / רווח. <b>נמוך יותר זה טוב יותר.</b>', e_pb: 'מחיר / הון עצמי. <b>נמוך יותר (במיוחד <1) זה טוב יותר.</b>', e_ps: 'מחיר / מכירות. <b>נמוך יותר זה טוב יותר.</b>', e_eps: 'רווח למניה. <b>גבוה יותר זה טוב יותר.</b>', e_roe: 'תשואה להון העצמי. <b>גבוה יותר זה טוב יותר.</b>', e_roa: 'תשואה על הנכסים. <b>גבוה יותר זה טוב יותר.</b>', p_today: 'היום', p_week: 'שבוע', p_month: 'חודש', p_1y: 'שנה', p_5y: '5 שנים', alert_no_ticker: 'אנא הזן לפחות סימבול אחד.', error_fetch: 'טעינת הנתונים נכשלה.' }
        };
        let currentLang = 'ru';

        function setLanguage(lang) {
            currentLang = lang; document.documentElement.lang = lang; document.body.classList.toggle('rtl', lang === 'he'); const langDict = translations[lang];
            document.querySelectorAll('[data-lang-key]').forEach(elem => { if (['TH', 'SPAN', 'OPTION'].includes(elem.tagName)) { elem.textContent = langDict[elem.getAttribute('data-lang-key')]; } else { elem.innerHTML = langDict[elem.getAttribute('data-lang-key')]; } });
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(elem => { elem.placeholder = langDict[elem.getAttribute('data-lang-key-placeholder')]; });
            document.querySelectorAll('th[data-tooltip-key]').forEach(elem => { elem.innerHTML = `${langDict[elem.getAttribute('data-lang-key')]}<span class="tooltip-text">${langDict[elem.getAttribute('data-tooltip-key')]}</span>`; });
            document.querySelectorAll('.lang-switcher button').forEach(btn => { btn.classList.remove('active'); }); document.getElementById(`lang-${lang}`).classList.add('active');
        }

        async function fetchData(tickers) {
            const tableBody = document.querySelector('#stock-table tbody');
            const loader = document.getElementById('loader');
            const period = document.getElementById('period-select').value;
            tableBody.innerHTML = ''; loader.style.display = 'block';

            for (const ticker of tickers) {
                const langHeaders = translations[currentLang];
                let row = `<tr><td data-label="${langHeaders.h_ticker}"><strong>${ticker}</strong></td>`;
                try {
                    const response = await fetch(`/.netlify/functions/fetchData?ticker=${ticker}&period=${period}`);
                    if (!response.ok) throw new Error(`Server error for ${ticker}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    const { price, changeHtml, marketCap, peRatio, pbRatio, psRatio, eps, roe, roa } = data;
                    row += `<td data-label="${langHeaders.h_price}">${price}</td> <td data-label="${langHeaders.h_change}">${changeHtml}</td> <td data-label="${langHeaders.h_market_cap}">${marketCap}</td> <td data-label="${langHeaders.h_pe}">${peRatio}</td> <td data-label="${langHeaders.h_pb}">${pbRatio}</td> <td data-label="${langHeaders.h_ps}">${psRatio}</td> <td data-label="${langHeaders.h_eps}">${eps}</td> <td data-label="${langHeaders.h_roe}">${roe}</td> <td data-label="${langHeaders.h_roa}">${roa}</td>`;
                } catch (error) {
                    console.error(`Failed to load data for ${ticker}:`, error);
                    row += `<td colspan="9" data-label="Error">${translations[currentLang].error_fetch}</td>`;
                } finally {
                    row += `</tr>`; tableBody.innerHTML += row;
                    if (tableBody.children.length === tickers.length) { loader.style.display = 'none'; }
                }
            }
        }
        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en')); document.getElementById('lang-ru').addEventListener('click', () => setLanguage('ru')); document.getElementById('lang-he').addEventListener('click', () => setLanguage('he'));
        document.getElementById('fetch-btn').addEventListener('click', () => {
            tickersOnScreen = document.getElementById('tickers-input').value.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
            if (tickersOnScreen.length === 0) { alert(translations[currentLang].alert_no_ticker); return; }
            fetchData(tickersOnScreen);
        });
        document.getElementById('period-select').addEventListener('change', () => { if (tickersOnScreen.length > 0) { fetchData(tickersOnScreen); } });
        setLanguage(currentLang);
    </script>
</body>
</html>
